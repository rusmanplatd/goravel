{{define "oauth/app-passwords.tmpl"}}
    {{template "layouts/header.tmpl" .}}
    {{template "layouts/nav.tmpl" .}}

    <!-- Page Content -->
    <main class="container py-4">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h1 class="h3 fw-semibold text-dark mb-1">App Passwords</h1>
                <p class="text-muted mb-0">Generate secure passwords for third-party applications</p>
            </div>
            <div>
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createAppPasswordModal">
                    <i class="fas fa-plus me-2"></i>Generate New Password
                </button>
            </div>
        </div>

        <!-- App Password Info -->
        <div class="card bg-info bg-opacity-10 border-info mb-4">
            <div class="card-body">
                <div class="d-flex align-items-start">
                    <div class="me-3">
                        <i class="fas fa-info-circle text-info fa-2x"></i>
                    </div>
                    <div>
                        <h5 class="text-info mb-2">About App Passwords</h5>
                        <p class="mb-2">App passwords are unique, randomly-generated passwords that give third-party apps access to your account without exposing your main password.</p>
                        <ul class="mb-0 small">
                            <li><strong>Security:</strong> Each app gets its own unique password</li>
                            <li><strong>Control:</strong> Revoke access anytime without changing your main password</li>
                            <li><strong>Monitoring:</strong> Track which apps are accessing your account</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <!-- App Passwords List -->
        <div class="card shadow-sm">
            <div class="card-header bg-white border-bottom">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Your App Passwords</h5>
                    <div class="input-group" style="width: 300px;">
                        <input type="text" class="form-control" placeholder="Search passwords..." id="searchPasswords">
                        <button class="btn btn-outline-secondary" type="button">
                            <i class="fas fa-search"></i>
                        </button>
                    </div>
                </div>
            </div>
            <div class="card-body p-0">
                {{if .app_passwords}}
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>Name</th>
                                <th>Permissions</th>
                                <th>Last Used</th>
                                <th>Created</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {{range .app_passwords}}
                            <tr>
                                <td>
                                    <div class="d-flex align-items-center">
                                        <div class="me-3">
                                            <div class="rounded-circle bg-primary bg-opacity-10 d-flex align-items-center justify-content-center" style="width: 40px; height: 40px;">
                                                <i class="fas fa-key text-primary"></i>
                                            </div>
                                        </div>
                                        <div>
                                            <div class="fw-medium">{{.name}}</div>
                                            <small class="text-muted">{{.description}}</small>
                                        </div>
                                    </div>
                                </td>
                                <td>
                                    <div class="d-flex flex-wrap gap-1">
                                        {{range .permissions}}
                                        <span class="badge bg-secondary">{{.}}</span>
                                        {{end}}
                                    </div>
                                </td>
                                <td>
                                    {{if .last_used}}
                                    <div class="text-muted small">{{.last_used}}</div>
                                    {{else}}
                                    <span class="text-muted small">Never</span>
                                    {{end}}
                                </td>
                                <td>
                                    <div class="text-muted small">{{.created_at}}</div>
                                </td>
                                <td>
                                    {{if eq .status "active"}}
                                    <span class="badge bg-success">Active</span>
                                    {{else if eq .status "revoked"}}
                                    <span class="badge bg-danger">Revoked</span>
                                    {{else}}
                                    <span class="badge bg-secondary">{{.status}}</span>
                                    {{end}}
                                </td>
                                <td>
                                    <div class="dropdown">
                                        <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                                            <i class="fas fa-ellipsis-v"></i>
                                        </button>
                                        <ul class="dropdown-menu">
                                            <li><a class="dropdown-item" href="#" onclick="viewDetails('{{.id}}')"><i class="fas fa-eye me-2"></i>View Details</a></li>
                                            <li><a class="dropdown-item" href="#" onclick="editPassword('{{.id}}')"><i class="fas fa-edit me-2"></i>Edit</a></li>
                                            {{if eq .status "active"}}
                                            <li><a class="dropdown-item" href="#" onclick="revokePassword('{{.id}}')"><i class="fas fa-ban me-2"></i>Revoke</a></li>
                                            {{end}}
                                            <li><hr class="dropdown-divider"></li>
                                            <li><a class="dropdown-item text-danger" href="#" onclick="deletePassword('{{.id}}')"><i class="fas fa-trash me-2"></i>Delete</a></li>
                                        </ul>
                                    </div>
                                </td>
                            </tr>
                            {{end}}
                        </tbody>
                    </table>
                </div>
                {{else}}
                <div class="text-center py-5">
                    <div class="mb-4">
                        <i class="fas fa-key fa-3x text-muted"></i>
                    </div>
                    <h4 class="text-muted mb-3">No app passwords created</h4>
                    <p class="text-muted mb-4">Create app passwords to give third-party applications secure access to your account.</p>
                    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createAppPasswordModal">
                        <i class="fas fa-plus me-2"></i>Generate Your First Password
                    </button>
                </div>
                {{end}}
            </div>
        </div>
    </main>

    <!-- Create App Password Modal -->
    <div class="modal fade" id="createAppPasswordModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-key me-2"></i>Generate App Password</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="createAppPasswordForm">
                        <div class="mb-3">
                            <label for="passwordName" class="form-label">Password Name</label>
                            <input type="text" class="form-control" id="passwordName" placeholder="e.g., Mobile App, Email Client" required>
                            <div class="form-text">Choose a descriptive name to identify this password</div>
                        </div>
                        <div class="mb-3">
                            <label for="passwordDescription" class="form-label">Description (Optional)</label>
                            <textarea class="form-control" id="passwordDescription" rows="2" placeholder="Additional details about this app password"></textarea>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Permissions</label>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="readPermission" checked>
                                <label class="form-check-label" for="readPermission">
                                    <strong>Read</strong> - View account information
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="writePermission">
                                <label class="form-check-label" for="writePermission">
                                    <strong>Write</strong> - Modify account data
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="adminPermission">
                                <label class="form-check-label" for="adminPermission">
                                    <strong>Admin</strong> - Full account access
                                </label>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="expiresAt" class="form-label">Expiration (Optional)</label>
                            <input type="date" class="form-control" id="expiresAt">
                            <div class="form-text">Leave blank for no expiration</div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="generatePassword()">
                        <i class="fas fa-key me-2"></i>Generate Password
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Generated Password Modal -->
    <div class="modal fade" id="generatedPasswordModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title text-success"><i class="fas fa-check-circle me-2"></i>Password Generated</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <strong>Important:</strong> This password will only be shown once. Please copy it now and store it securely.
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Your new app password:</label>
                        <div class="input-group">
                            <input type="text" class="form-control font-monospace" id="generatedPassword" readonly>
                            <button class="btn btn-outline-secondary" type="button" onclick="copyPassword()">
                                <i class="fas fa-copy"></i>
                            </button>
                        </div>
                    </div>
                    <div class="bg-light p-3 rounded">
                        <h6>Next Steps:</h6>
                        <ol class="mb-0 small">
                            <li>Copy this password to your clipboard</li>
                            <li>Use it in your third-party application</li>
                            <li>Store it securely in your password manager</li>
                            <li>You can revoke this password anytime from this page</li>
                        </ol>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">I've Copied It</button>
                </div>
            </div>
        </div>
    </div>

    <script>
    $(document).ready(function() {
        // Search functionality
        $('#searchPasswords').on('input', function() {
            const searchTerm = $(this).val().toLowerCase();
            $('tbody tr').each(function() {
                const text = $(this).text().toLowerCase();
                if (text.includes(searchTerm)) {
                    $(this).show();
                } else {
                    $(this).hide();
                }
            });
        });
    });

    function generatePassword() {
        const name = $('#passwordName').val().trim();
        if (!name) {
            showError('Please enter a password name');
            return;
        }

        // Simulate password generation
        const password = 'app-' + Math.random().toString(36).substring(2, 15) + Math.random().toString(36).substring(2, 15);
        $('#generatedPassword').val(password);
        
        $('#createAppPasswordModal').modal('hide');
        $('#generatedPasswordModal').modal('show');
        
        showSuccess('App password generated successfully!');
        
        // Reset form
        $('#createAppPasswordForm')[0].reset();
    }

    function copyPassword() {
        const password = $('#generatedPassword').val();
        navigator.clipboard.writeText(password).then(function() {
            showSuccess('Password copied to clipboard!');
        });
    }

    function viewDetails(id) {
        showSuccess(`Viewing details for password ${id}`);
    }

    function editPassword(id) {
        showSuccess(`Editing password ${id}`);
    }

    function revokePassword(id) {
        Swal.fire({
            title: 'Revoke App Password?',
            text: 'This will immediately revoke access for this application.',
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#dc3545',
            cancelButtonColor: '#6c757d',
            confirmButtonText: 'Yes, revoke it!'
        }).then((result) => {
            if (result.isConfirmed) {
                showSuccess('App password revoked successfully!');
                setTimeout(() => location.reload(), 1000);
            }
        });
    }

    function deletePassword(id) {
        Swal.fire({
            title: 'Delete App Password?',
            text: 'This action cannot be undone.',
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#dc3545',
            cancelButtonColor: '#6c757d',
            confirmButtonText: 'Yes, delete it!'
        }).then((result) => {
            if (result.isConfirmed) {
                showSuccess('App password deleted successfully!');
                setTimeout(() => location.reload(), 1000);
            }
        });
    }

    function showSuccess(message) {
        Swal.fire({
            icon: 'success',
            title: 'Success',
            text: message,
            timer: 2000,
            showConfirmButton: false
        });
    }

    function showError(message) {
        Swal.fire({
            icon: 'error',
            title: 'Error',
            text: message
        });
    }
    </script>

    {{template "layouts/footer.tmpl" .}}
{{end}} 